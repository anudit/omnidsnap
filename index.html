<!doctype html>
<html>
  </head>
    <title>Hello, Snaps!</title>
    <link rel="icon" type="image/svg" href="./images/icon.svg"/>
  </head>

  <body>
    <h1>Hello, Snaps!</h1>
    <br/>

    <h2>Step 1</h2>
    <button onclick="addSnap()">Add Snap to Metmask</button>
    <br/><br/>

    <h2>Step 1</h2>
    <button onclick="updateAddress()">Connect Wallet</button>
    <br/><br/>

    <h2>Step 2</h2>
    <button onclick="sendMine()">Get Mine</button>
    <br/><br/>

    <h2>Step 3</h2>
    <input type="text" id="add" placeholder="Ethereum Address" value="0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045"/>
    <button onclick="sendX()">Calculate Score</button>
    <br/><br/>

    <h2>Output</h2>
    <pre id="resp">

    </pre>

  </body>

  <script>
    // const snapId = `local:${window.location.href}`;
    const snapId = `npm:@omnid/snap`;
    let accounts = [];

    async function addSnap() {
      await ethereum.request({
        method: 'wallet_enable',
        params: [{
          wallet_snap: { [snapId]: {} },
        }]
      })
    }
    async function updateAddress() {
      accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      alert('Done')
    }

    async function sendMine() {
      await sendRequest(accounts[0]);
    }

    async function sendX() {
      await sendRequest('0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045');
    }

    async function sendRequest(address){
      try {
        const response = await ethereum.request({
          method: 'wallet_invokeSnap',
          params: [snapId, {
            method: 'omnid_getTrustScoreData',
            address: address,
            apikey: 'CONVO',
          }]
        })
        console.log('response', response);
        document.getElementById('resp').innerText = JSON.stringify(response, null, 2);
      } catch (err) {
        console.error(err)
        alert('Problem happened: ' + err.message || err)
      }
    }

  </script>
</html>
